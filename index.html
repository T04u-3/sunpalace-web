<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ホール音響シミュレーター</title>
<link rel="icon" href="favicon.png">

<style>
body{
  font-family: sans-serif;
  background:#111;
  color:white;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
  margin:0;
  overflow:hidden;
}

.container{
  width:520px;
  text-align:center;
}

h1{
  font-weight:300;
  margin-bottom:30px;
}

.drop{
  border:2px dashed #555;
  padding:45px;
  border-radius:14px;
  margin-bottom:15px;
  cursor:pointer;
  transition:0.2s;
}

.drop:hover{ border-color:#aaa; }
.drop.active{
  border-color:#00bcd4;
  background:#151515;
}

.filename{
  margin-bottom:25px;
  font-size:14px;
  color:#bbb;
}

.controls button{
  font-size:18px;
  padding:12px 20px;
  margin:8px;
  border:none;
  border-radius:8px;
  background:#222;
  color:white;
  cursor:pointer;
}

.controls button:hover{ background:#444; }

/* 波形 */
#waveContainer{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  height:180px;
  pointer-events:none;
}

canvas{
  width:100%;
  height:100%;
  background:transparent;
}
</style>
</head>

<body>

<div class="container">
<h1>ホール音響シミュレーター</h1>

<div class="drop" id="drop">
音源をドラッグ or クリック
</div>

<div class="filename" id="filename">
ファイル未選択
</div>

<div class="controls">
<button id="play">再生</button>
<button id="pause">一時停止</button>
<button id="stop">停止</button>
<button id="reset">音源を削除</button>
</div>

<input type="file" id="fileInput" hidden>
</div>

<div id="waveContainer">
<canvas id="wave"></canvas>
</div>

<script>
/* ===== WebAudio ===== */
let audioCtx = new AudioContext();
let convolver = audioCtx.createConvolver();
let analyser = audioCtx.createAnalyser();

let source = null;
let buffer = null;
let videoElement = null;
let videoSource = null;

analyser.fftSize = 256;

/* ===== ホールIR ===== */
fetch("fukuoka_sunpalace_2F_center_PRO_FINAL.wav")
.then(r=>r.arrayBuffer())
.then(data=>audioCtx.decodeAudioData(data))
.then(ir=>{
  convolver.buffer = ir;
  convolver.connect(analyser);
  analyser.connect(audioCtx.destination);
});

/* ===== UI ===== */
const drop = document.getElementById("drop");
const filenameText = document.getElementById("filename");
const fileInput = document.getElementById("fileInput");

/* ===== ファイル読み込み ===== */
async function loadFile(file){
  if(!file) return;

  filenameText.textContent = file.name;

  const url = URL.createObjectURL(file);
  const name = file.name.toLowerCase();
  const isVideo = name.match(/\.(mp4|mov|avi|mkv|webm)$/);

  /* ===== 動画 ===== */
  if(isVideo){
    videoElement = document.createElement("video");
    videoElement.src = url;
    videoElement.crossOrigin = "anonymous";

    videoElement.onloadeddata = ()=>{
      if(videoSource) videoSource.disconnect();

      videoSource = audioCtx.createMediaElementSource(videoElement);

      const gain = audioCtx.createGain();
      gain.gain.value = 0.7; // 音量統一

      videoSource.connect(gain);
      gain.connect(convolver);
    };

    buffer = null;

  }else{
    /* ===== 音声 ===== */
    const reader = new FileReader();

    reader.onload = function(ev){
      audioCtx.decodeAudioData(ev.target.result, decoded=>{
        buffer = decoded;
      });
    };

    reader.readAsArrayBuffer(file);
  }
}

/* ===== ドラッグ ===== */
drop.addEventListener("dragover", e=>{
  e.preventDefault();
  drop.classList.add("active");
});

drop.addEventListener("dragleave", ()=> drop.classList.remove("active"));

drop.addEventListener("drop", async e=>{
  e.preventDefault();
  loadFile(e.dataTransfer.files[0]);
});

/* ===== クリック ===== */
drop.addEventListener("click", ()=> fileInput.click());

fileInput.addEventListener("change", ()=>{
  loadFile(fileInput.files[0]);
});

/* ===== 再生 ===== */
document.getElementById("play").onclick = async ()=>{
  await audioCtx.resume();

  /* 動画 */
  if(videoElement){
    videoElement.play();
    drawWave();
    return;
  }

  /* 音声 */
  if(!buffer) return;

  if(source) source.stop();

  source = audioCtx.createBufferSource();
  source.buffer = buffer;

  const gain = audioCtx.createGain();
  gain.gain.value = 0.7;

  source.connect(gain);
  gain.connect(convolver);

  source.start();

  drawWave();
};

/* ===== 一時停止 ===== */
document.getElementById("pause").onclick = ()=>{
  audioCtx.suspend();
  if(videoElement) videoElement.pause();
};

/* ===== 停止 ===== */
document.getElementById("stop").onclick = ()=>{
  if(source) source.stop();
  if(videoElement) videoElement.pause();
};

/* ===== リセット ===== */
document.getElementById("reset").onclick = ()=>{
  buffer = null;
  videoElement = null;
  filenameText.textContent = "ファイル未選択";
  if(source) source.stop();
};

/* ===== 波形 ===== */
const canvas = document.getElementById("wave");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = 180;
}
resize();
window.addEventListener("resize", resize);

function drawWave(){
  const bufferLength = analyser.frequencyBinCount;
  const data = new Uint8Array(bufferLength);

  function loop(){
    analyser.getByteFrequencyData(data);
    ctx.clearRect(0,0,canvas.width,canvas.height);

    const barWidth = canvas.width / bufferLength * 1.5;
    let x = 0;

    for(let i=0;i<bufferLength;i++){
      let value = Math.pow(data[i]/255,0.6);
      const barHeight = value * canvas.height;

      const gradient = ctx.createLinearGradient(
        0,
        canvas.height - barHeight,
        0,
        canvas.height
      );

      gradient.addColorStop(0,"rgba(0,255,255,0.9)");
      gradient.addColorStop(0.5,"rgba(0,188,212,0.7)");
      gradient.addColorStop(1,"rgba(0,124,145,0.35)");

      ctx.fillStyle = gradient;

      ctx.fillRect(
        x,
        canvas.height - barHeight,
        barWidth,
        barHeight
      );

      x += barWidth + 2;
    }

    requestAnimationFrame(loop);
  }

  loop();
}
</script>

</body>
</html>
